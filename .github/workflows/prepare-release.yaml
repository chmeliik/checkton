name: Prepare Release
on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: Version to release, e.g. 'v0.1.0'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  SCOPED_NAME: ${{ github.repository }}  # owner/repo_name
  IMAGE: ghcr.io/${{ github.repository }}
  VERSION: ${{ inputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      packages: write
      contents: read

    outputs:
      digest: ${{ steps.push.outputs.digest }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Build image
        uses: redhat-actions/buildah-build@7a95fa7ee0f02d552a32753e7414641a04307056 # v2
        with:
          containerfiles: Dockerfile
          image: ${{ env.IMAGE }}
          tags: |
            ${{ github.sha }}
            ${{ inputs.version }}

      - name: Generate SBOM
        uses: anchore/sbom-action@e11c554f704a0b820cbf8c51673f6945e0731532 # v0
        with:
          image: ${{ env.IMAGE }}:${{ github.sha }}
          format: cyclonedx-json
          output-file: .sbom.json
          upload-artifact: false
          upload-release-assets: false
